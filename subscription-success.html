<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Subscription Successful - UseShield</title>
    <link rel="stylesheet" href="shared.css" />
    <style>
      body {
        background: var(--gradient-primary);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
        padding: var(--space-lg);
      }
      .success-container {
        max-width: 600px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-xl);
        padding: var(--space-2xl);
        box-shadow: var(--shadow-xl);
      }
      .success-icon {
        width: 80px;
        height: 80px;
        background: var(--color-success);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto var(--space-lg);
        animation: scaleIn 0.5s ease-out;
      }
      @keyframes scaleIn {
        from { transform: scale(0); }
        to { transform: scale(1); }
      }
      h1 {
        font-size: var(--text-3xl);
        margin-bottom: var(--space-md);
      }
      p {
        font-size: var(--text-lg);
        opacity: 0.9;
        margin-bottom: var(--space-xl);
      }
      .license-box {
        background: rgba(255,255,255,0.15);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-xl);
      }
      .license-box h3 {
        font-size: var(--text-base);
        margin-bottom: var(--space-sm);
        opacity: 0.8;
      }
      .license-key {
        font-size: var(--text-xl);
        font-weight: 700;
        font-family: 'Monaco', 'Courier New', monospace;
        letter-spacing: 2px;
        margin-bottom: var(--space-md);
      }
      .copy-btn {
        padding: var(--space-sm) var(--space-lg);
        background: white;
        color: var(--color-primary);
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition-fast);
      }
      .copy-btn:hover {
        transform: translateY(-2px);
      }
      .copy-btn.copied {
        background: var(--color-success);
        color: white;
      }
      .action-buttons {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        flex-wrap: wrap;
      }
      .btn {
        padding: var(--space-md) var(--space-xl);
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        text-decoration: none;
        display: inline-block;
      }
      .btn-primary {
        background: white;
        color: var(--color-primary);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }
      .btn-secondary {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
      }
      .btn-secondary:hover {
        background: rgba(255,255,255,0.3);
      }
      .loading {
        text-align: center;
      }
      .spinner {
        border: 4px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top: 4px solid white;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-md);
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="success-container">
      <!-- Loading state -->
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <h2>Activating your subscription...</h2>
        <p>Please wait while we process your purchase.</p>
      </div>

      <!-- Success state -->
      <div id="successState" style="display:none;">
        <div class="success-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        
        <h1>Welcome to <span id="tierName">Pro</span>! ðŸŽ‰</h1>
        <p>Your subscription has been activated successfully.</p>
        
        <div class="license-box">
          <h3>Your License Key</h3>
          <div class="license-key" id="licenseKey">Loading...</div>
          <button class="copy-btn" id="copyLicenseBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px;">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy License Key
          </button>
          <p style="font-size:var(--text-sm);opacity:0.8;margin-top:var(--space-md);margin-bottom:0;">
            Save this key! You'll need it to activate on other devices.
          </p>
        </div>
        
        <div class="action-buttons">
          <a href="popup.html" class="btn btn-primary">Start Analyzing</a>
          <a href="subscription.html" class="btn btn-secondary">View Subscription</a>
        </div>
      </div>

      <!-- Error state -->
      <div id="errorState" style="display:none;">
        <div class="success-icon" style="background:var(--color-danger);">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        
        <h1>Oops! Something went wrong</h1>
        <p id="errorMessage">We couldn't activate your subscription. Please contact support with your order details.</p>
        
        <div class="action-buttons">
          <a href="subscription.html" class="btn btn-primary">Back to Subscription</a>
          <a href="mailto:support@useshield.net" class="btn btn-secondary">Contact Support</a>
        </div>
      </div>
    </div>

    <script type="module">
      import { activateLicense, getSubscription } from './src/lemonsqueezy.js';

      const loadingState = document.getElementById('loadingState');
      const successState = document.getElementById('successState');
      const errorState = document.getElementById('errorState');
      const tierNameEl = document.getElementById('tierName');
      const licenseKeyEl = document.getElementById('licenseKey');
      const copyLicenseBtn = document.getElementById('copyLicenseBtn');

      async function processActivation() {
        try {
          // Parse URL parameters (license key might be passed from Lemon Squeezy)
          const urlParams = new URLSearchParams(window.location.search);
          const licenseKey = urlParams.get('license_key') || urlParams.get('key');

          if (licenseKey) {
            // Activate the license
            const result = await activateLicense(licenseKey);
            
            if (result.success || result.valid) {
              const subscription = result.subscription || await getSubscription();
              
              // Show success state
              loadingState.style.display = 'none';
              successState.style.display = 'block';
              
              // Display tier name
              const tierNames = {
                starter: 'Starter',
                pro: 'Pro',
                pro_plus: 'Pro Plus',
                agency: 'Agency'
              };
              tierNameEl.textContent = tierNames[subscription.tier] || 'Pro';
              
              // Display license key
              licenseKeyEl.textContent = licenseKey;
              
              // Setup copy button
              copyLicenseBtn.addEventListener('click', async () => {
                await navigator.clipboard.writeText(licenseKey);
                copyLicenseBtn.classList.add('copied');
                copyLicenseBtn.innerHTML = `
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px;">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  Copied!
                `;
                setTimeout(() => {
                  copyLicenseBtn.classList.remove('copied');
                  copyLicenseBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px;">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy License Key
                  `;
                }, 2000);
              });
            } else {
              showError(result.error || 'License activation failed');
            }
          } else {
            // No license key in URL - check if already activated
            const subscription = await getSubscription();
            
            if (subscription && subscription.status === 'active') {
              // Already have active subscription
              loadingState.style.display = 'none';
              successState.style.display = 'block';
              
              const tierNames = {
                starter: 'Starter',
                pro: 'Pro',
                pro_plus: 'Pro Plus',
                agency: 'Agency'
              };
              tierNameEl.textContent = tierNames[subscription.tier] || 'Pro';
              licenseKeyEl.textContent = subscription.licenseKey || 'Hidden for security';
              copyLicenseBtn.style.display = subscription.licenseKey ? 'inline-block' : 'none';
            } else {
              showError('No license key found. Please check your email or enter it manually on the subscription page.');
            }
          }
        } catch (error) {
          console.error('Activation error:', error);
          showError(error.message);
        }
      }

      function showError(message) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
      }

      // Start activation process
      processActivation();
    </script>
  </body>
</html>
