<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - UseShield</title>
    <link rel="stylesheet" href="shared.css">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3a5f 0%, #0a1628 50%, #1a1a2e 100%);
            padding: var(--spacing-xl);
        }

        .reset-container {
            width: 100%;
            max-width: 400px;
            background: var(--surface-0);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--elev-3);
        }

        .reset-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .reset-header svg {
            margin-bottom: var(--spacing-md);
        }

        .reset-header h1 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-gray-900);
            margin-bottom: var(--spacing-xs);
        }

        .reset-header p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-gray-700);
            margin-bottom: var(--spacing-xs);
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: var(--spacing-md);
            color: var(--color-gray-400);
            pointer-events: none;
        }

        .input-wrapper input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            padding-left: 42px;
            font-size: var(--font-size-base);
            color: var(--color-gray-900);
            background: var(--surface-1);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            outline: none;
            transition: var(--transition-fast);
        }

        .input-wrapper input:focus {
            background: var(--surface-0);
            border-color: rgba(59, 130, 246, 0.55);
            box-shadow: var(--ring);
        }

        .password-toggle {
            position: absolute;
            right: var(--spacing-sm);
            background: none;
            border: none;
            padding: var(--spacing-sm);
            cursor: pointer;
            color: var(--color-gray-400);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
        }

        .password-toggle:hover {
            color: var(--color-gray-600);
            background: var(--surface-2);
        }

        .form-hint {
            display: block;
            font-size: var(--font-size-xs);
            color: var(--color-gray-400);
            margin-top: var(--spacing-xs);
        }

        .reset-btn {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-white);
            background: var(--color-accent);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .reset-btn:hover {
            background: var(--color-accent-hover);
        }

        .reset-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .reset-error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-lg);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .reset-success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-lg);
            border: 1px solid rgba(16, 185, 129, 0.2);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .loading-state {
            text-align: center;
            padding: var(--spacing-2xl);
        }

        .loading-state .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-lg);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-spinner {
            animation: spin 1s linear infinite;
        }

        .invalid-token {
            text-align: center;
        }

        .invalid-token svg {
            color: var(--color-danger);
            margin-bottom: var(--spacing-md);
        }

        .invalid-token h2 {
            font-size: var(--font-size-lg);
            color: var(--color-gray-900);
            margin-bottom: var(--spacing-sm);
        }

        .invalid-token p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
            margin-bottom: var(--spacing-lg);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--color-accent);
            text-decoration: none;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="reset-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>Verifying your reset link...</p>
        </div>

        <!-- Invalid Token State -->
        <div id="invalidState" class="invalid-token" hidden>
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <h2>Invalid or Expired Link</h2>
            <p>This password reset link is no longer valid. Please request a new one.</p>
            <a href="#" class="back-link" id="backToPopup">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back to extension
            </a>
        </div>

        <!-- Reset Form State -->
        <div id="resetFormState" hidden>
            <div class="reset-header">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)"
                    stroke-width="1.5">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                <h1>Create new password</h1>
                <p>Enter a strong password for your account</p>
            </div>

            <div id="resetError" class="reset-error" hidden></div>
            <div id="resetSuccess" class="reset-success" hidden></div>

            <form id="resetForm">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <input type="password" id="newPassword" placeholder="••••••••" required minlength="8"
                            autocomplete="new-password">
                        <button type="button" class="password-toggle" id="toggleNewPassword">
                            <svg class="eye-open" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <svg class="eye-closed" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" style="display:none">
                                <path
                                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94">
                                </path>
                                <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"></path>
                                <line x1="1" y1="1" x2="23" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                    <small class="form-hint">At least 8 characters</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <input type="password" id="confirmPassword" placeholder="••••••••" required minlength="8"
                            autocomplete="new-password">
                    </div>
                </div>

                <button type="submit" class="reset-btn" id="submitBtn">
                    <span class="btn-text">Reset Password</span>
                    <svg class="btn-spinner" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" style="display:none">
                        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { changePassword } from './src/auth.js';

        // Parse URL hash for recovery token
        function parseHash() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return {
                accessToken: params.get('access_token'),
                refreshToken: params.get('refresh_token'),
                type: params.get('type'),
                expiresAt: params.get('expires_at'),
                expiresIn: params.get('expires_in')
            };
        }

        // Initialize
        async function init() {
            const loadingState = document.getElementById('loadingState');
            const invalidState = document.getElementById('invalidState');
            const resetFormState = document.getElementById('resetFormState');

            const { accessToken, refreshToken, type, expiresAt, expiresIn } = parseHash();

            // Check if this is a recovery flow
            if (type !== 'recovery' || !accessToken) {
                loadingState.hidden = true;
                invalidState.hidden = false;
                return;
            }

            // Store the session for password update
            try {
                await chrome.storage.local.set({
                    supabase_session: {
                        access_token: accessToken,
                        refresh_token: refreshToken,
                        expires_at: parseInt(expiresAt),
                        expires_in: parseInt(expiresIn)
                    }
                });

                // Show reset form
                loadingState.hidden = true;
                resetFormState.hidden = false;
                document.getElementById('newPassword').focus();
            } catch (error) {
                console.error('Error storing session:', error);
                loadingState.hidden = true;
                invalidState.hidden = false;
            }
        }

        // Handle form submission
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('resetError');
            const successEl = document.getElementById('resetSuccess');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnSpinner = submitBtn.querySelector('.btn-spinner');

            // Validation
            if (newPassword.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.hidden = false;
                return;
            }

            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.hidden = false;
                return;
            }

            // Show loading
            submitBtn.disabled = true;
            btnText.textContent = 'Resetting...';
            btnSpinner.style.display = 'inline-block';
            errorEl.hidden = true;

            try {
                const result = await changePassword(newPassword);

                if (result.success) {
                    successEl.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>Password reset successfully! You can now close this page.</span>
          `;
                    successEl.hidden = false;
                    document.getElementById('resetForm').hidden = true;
                } else {
                    errorEl.textContent = result.error || 'Failed to reset password';
                    errorEl.hidden = false;
                }
            } catch (error) {
                console.error('Password reset error:', error);
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.hidden = false;
            } finally {
                submitBtn.disabled = false;
                btnText.textContent = 'Reset Password';
                btnSpinner.style.display = 'none';
            }
        });

        // Password toggle
        document.getElementById('toggleNewPassword').addEventListener('click', () => {
            const input = document.getElementById('newPassword');
            const eyeOpen = document.querySelector('.eye-open');
            const eyeClosed = document.querySelector('.eye-closed');

            if (input.type === 'password') {
                input.type = 'text';
                eyeOpen.style.display = 'none';
                eyeClosed.style.display = 'block';
            } else {
                input.type = 'password';
                eyeOpen.style.display = 'block';
                eyeClosed.style.display = 'none';
            }
        });

        // Back to popup
        document.getElementById('backToPopup').addEventListener('click', (e) => {
            e.preventDefault();
            window.close();
        });

        // Run init
        init();
    </script>
</body>

</html>